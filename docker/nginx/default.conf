server {
    listen 8080;

    # ドキュメントルート: webコンテナ内の静的ファイル（CSS/JS/画像等）が配置されるディレクトリ
    # PHPファイルはここに存在しなくてよい（PHP-FPMコンテナ側に存在する）
    root /var/www/public;

    index index.php index.html;

    # アップロードファイルの最大サイズ（PHPのupload_max_filesizeと合わせる）
    client_max_body_size 100M;

    # サーバー情報の漏洩を防ぐ（アタックサーフェスの削減）
    server_tokens off;

    # 静的ファイルはNginxが直接配信し、その他のリクエストはindex.phpへ転送する
    # Laravelのフロントコントローラーパターンに対応したURLルーティング
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHPファイルへのリクエストをサイドカーのPHP-FPMコンテナへ転送する
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;

        # 【サイドカーパターン / ECS Fargate awsvpc モード】
        # ECS Fargate の awsvpc ネットワークモードでは、同一タスク内のコンテナは
        # 同じネットワーク名前空間を共有する。そのためNginxからPHP-FPMへは
        # 127.0.0.1（localhost）経由で接続できる。
        fastcgi_pass 127.0.0.1:9000;

        fastcgi_index index.php;
        include fastcgi_params;

        # SCRIPT_FILENAMEはPHP-FPM（appコンテナ）側のファイルシステムパスを指定する。
        # appコンテナとwebコンテナで同一パス(/var/www/public)を使用しているため整合する。
        # このパスがPHP-FPMが実行するスクリプトの場所を示す。
        fastcgi_param SCRIPT_FILENAME /var/www/public$fastcgi_script_name;
        fastcgi_param PATH_INFO       $fastcgi_path_info;

        # ALBを経由した実IPアドレスをPHPに渡す（ログ・レート制限等に使用）
        fastcgi_param HTTP_X_REAL_IP  $remote_addr;

        # タイムアウト設定（PHPの max_execution_time と合わせる）
        fastcgi_read_timeout 600;
    }

    # 【セキュリティ】隠しファイル（.env / .git / .htaccess 等）へのアクセスを拒否する
    # 設定ファイルや認証情報が意図せず公開されることを防ぐ
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 静的アセットのキャッシュ設定（CDNなしの場合のブラウザキャッシュ最適化）
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}
