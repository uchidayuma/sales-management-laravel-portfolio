# ECS ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è§£èª¬

> **ã“ã®è¨­å®šã¯ãªãœé›£ã—ã„ã®ã‹**
> ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã€ã€Œãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€ã€ŒLinux ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã€ã¨ã„ã†
> 3 ã¤ã®ç‹¬ç«‹ã—ãŸä»•çµ„ã¿ãŒçµ¡ã¿åˆã†ãŸã‚ã€1 ã¤ã ã‘çŸ¥ã£ã¦ã„ã¦ã‚‚æ­£ã—ã„è¨­å®šã«ãŸã©ã‚Šç€ã‘ãªã„ã€‚

---

## æœ€çµ‚çš„ãªæ­£è§£ï¼ˆçµè«–ã‹ã‚‰ï¼‰

è©¦è¡ŒéŒ¯èª¤ã®æœ«ã«è¡Œãç€ã„ãŸè¨­å®šã‚’å…ˆã«ç¤ºã™ã€‚

| è¨­å®šé …ç›® | app ã‚³ãƒ³ãƒ†ãƒŠ (PHP-FPM) | web ã‚³ãƒ³ãƒ†ãƒŠ (Nginx) |
|---------|----------------------|-------------------|
| `readonlyRootFilesystem` | `true` | `true` |
| `capabilities.drop` | `["MKNOD","AUDIT_WRITE","SETFCAP","NET_RAW"]` | `["MKNOD","AUDIT_WRITE","SETFCAP","NET_RAW"]` |
| `capabilities.add` | `[]` | `[]` |
| ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒžã‚¦ãƒ³ãƒˆï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½é ˜åŸŸï¼‰ | `/tmp` | `/var/cache/nginx` `/var/run` |
| ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼ | rootï¼ˆDockerfile ã« USER æŒ‡å®šãªã—ï¼‰ | rootï¼ˆNginx ã®æ¨™æº–å‹•ä½œï¼‰ |
| å®Ÿéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ | www-dataï¼ˆPHP-FPM pool è¨­å®šï¼‰ | nginx ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆnginx.conf è¨­å®šï¼‰ |

---

## ä»•çµ„ã¿â‘  readonlyRootFilesystemï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰

### ä½•ã‚’ã™ã‚‹ã®ã‹

```
[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç›®çš„]
ã‚³ãƒ³ãƒ†ãƒŠãŒä¹—ã£å–ã‚‰ã‚Œã¦ã‚‚ã€æ”»æ’ƒè€…ãŒãƒžãƒ«ã‚¦ã‚§ã‚¢ã‚„ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’
ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
```

ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šã€‚

```
readonlyRootFilesystem = falseï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰  â†’  readonlyRootFilesystem = true
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/var/www/    èª­ã¿æ›¸ãå¯                            èª­ã¿å–ã‚Šã®ã¿ âœ…ï¼ˆæ›¸ã‹ã›ãªã„ï¼‰
/etc/        èª­ã¿æ›¸ãå¯                            èª­ã¿å–ã‚Šã®ã¿ âœ…
/tmp/        èª­ã¿æ›¸ãå¯      â†’â†’â†’                  èª­ã¿å–ã‚Šã®ã¿ âš ï¸ï¼ˆå•é¡Œã«ãªã‚‹ï¼‰
/var/run/    èª­ã¿æ›¸ãå¯                            èª­ã¿å–ã‚Šã®ã¿ âš ï¸ï¼ˆå•é¡Œã«ãªã‚‹ï¼‰
/var/cache/  èª­ã¿æ›¸ãå¯                            èª­ã¿å–ã‚Šã®ã¿ âš ï¸ï¼ˆå•é¡Œã«ãªã‚‹ï¼‰
```

### å•é¡Œï¼šãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯èµ·å‹•æ™‚ã«æ›¸ãè¾¼ã¿ã‚’å¿…è¦ã¨ã™ã‚‹

PHP-FPMãƒ»Nginx ã¯èµ·å‹•æ™‚ã«ç‰¹å®šã®ãƒ‘ã‚¹ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚‚ã†ã¨ã™ã‚‹ã€‚

| ã‚³ãƒ³ãƒ†ãƒŠ | æ›¸ãè¾¼ã‚‚ã†ã¨ã™ã‚‹å ´æ‰€ | ç”¨é€” |
|---------|------------------|------|
| app (PHP-FPM) | `/tmp/` | accept mutex ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŽ¥ç¶šç®¡ç†ï¼‰ |
| web (Nginx) | `/var/cache/nginx/` | ãƒ—ãƒ­ã‚­ã‚·ãƒãƒƒãƒ•ã‚¡ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ« |
| web (Nginx) | `/var/run/` | PID ãƒ•ã‚¡ã‚¤ãƒ« |

### è§£æ±ºç­–ï¼šæ›¸ãè¾¼ã¿ãŒå¿…è¦ãªå ´æ‰€ã ã‘ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒžã‚¦ãƒ³ãƒˆã™ã‚‹

ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å®šç¾©ã—ã€ç‰¹å®šãƒ‘ã‚¹ã ã‘ã‚’ã€Œæ›¸ãè¾¼ã¿å¯èƒ½ã€ã«ã™ã‚‹ã€‚

```hcl
# terraform/ecs.tf

# â‘  ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾©ï¼ˆã‚¿ã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ï¼‰
volume { name = "tmp" }           # app ã® /tmp ç”¨
volume { name = "nginx_cache" }   # web ã® /var/cache/nginx ç”¨
volume { name = "nginx_run" }     # web ã® /var/run ç”¨

# â‘¡ app ã‚³ãƒ³ãƒ†ãƒŠã¸ã®ãƒžã‚¦ãƒ³ãƒˆ
mountPoints = [
  { sourceVolume = "tmp", containerPath = "/tmp", readOnly = false }
]

# â‘¢ web ã‚³ãƒ³ãƒ†ãƒŠã¸ã®ãƒžã‚¦ãƒ³ãƒˆ
mountPoints = [
  { sourceVolume = "nginx_cache", containerPath = "/var/cache/nginx", readOnly = false },
  { sourceVolume = "nginx_run",   containerPath = "/var/run",         readOnly = false }
]
```

```
ãƒžã‚¦ãƒ³ãƒˆå¾Œã®çŠ¶æ…‹:
/var/www/          â†’ èª­ã¿å–ã‚Šã®ã¿ï¼ˆæ”»æ’ƒè€…ã¯ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚ãªã„ï¼‰âœ…
/tmp/              â†’ æ›¸ãè¾¼ã¿å¯ï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒžã‚¦ãƒ³ãƒˆï¼‰
/var/run/          â†’ æ›¸ãè¾¼ã¿å¯ï¼ˆweb ã®ã¿ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒžã‚¦ãƒ³ãƒˆï¼‰
/var/cache/nginx/  â†’ æ›¸ãè¾¼ã¿å¯ï¼ˆweb ã®ã¿ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒžã‚¦ãƒ³ãƒˆï¼‰
```

---

## ä»•çµ„ã¿â‘¡ã€é‡è¦ã€‘ECS Fargate ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ã€Œç©ºã® root æ‰€æœ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã¨ã—ã¦ä½œæˆã•ã‚Œã‚‹

### ã“ã‚ŒãŒæœ€ã‚‚ç†è§£ã—ã«ãã„è½ã¨ã—ç©´

ãƒ­ãƒ¼ã‚«ãƒ«ã® Docker ã¨ ECS Fargate ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®**åˆæœŸåŒ–æ–¹æ³•ãŒç•°ãªã‚‹**ã€‚

```
ã€ãƒ­ãƒ¼ã‚«ãƒ« Docker ã®æŒ™å‹•ã€‘
åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ /tmp ã«ãƒžã‚¦ãƒ³ãƒˆ
â†’ Docker ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã® /tmp ã®å†…å®¹ï¼ˆãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å«ã‚€ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
â†’ /tmp ã¯ drwxrwxrwt (1777) = èª°ã§ã‚‚æ›¸ãè¾¼ã‚ã‚‹

ã€ECS Fargate ã®æŒ™å‹•ã€‘  â† ã“ã“ãŒè½ã¨ã—ç©´
ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ /tmp ã«ãƒžã‚¦ãƒ³ãƒˆ
â†’ ã€Œç©ºã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã¨ã—ã¦æ–°è¦ä½œæˆã•ã‚Œã‚‹
â†’ /tmp ã¯ drwxr-xr-x (755) = root ã—ã‹æ›¸ãè¾¼ã‚ãªã„
```

### ãªãœã“ã‚ŒãŒå•é¡Œã«ãªã‚‹ã®ã‹

ãƒ­ãƒ¼ã‚«ãƒ«ã§ `docker run --read-only --tmpfs /tmp --user www-data` ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨æ­£å¸¸ã«å‹•ãã€‚
ã—ã‹ã— ECS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ `/tmp` ãŒ `root:root 755` ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€
www-data ã§èµ·å‹•ã—ãŸ PHP-FPM ãŒ `/tmp` ã«æ›¸ãè¾¼ã‚ãšèµ·å‹•å¤±æ•—ã™ã‚‹ã€‚

```
å®Ÿéš›ã«å‡ºãŸã‚¨ãƒ©ãƒ¼ï¼ˆCloudWatch Logsï¼‰:
Fatal Error Unable to create lock file: Permission denied (13)
```

> **ãƒã‚¤ãƒ³ãƒˆ**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯å‹•ãã®ã« ECS ã ã¨å‹•ã‹ãªã„ã€ã¨ã„ã†çŠ¶æ³ãŒã“ã®é•ã„ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹ã€‚
> ã€Œãƒ†ã‚¹ãƒˆç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®å·®ç•°ã€ã®å…¸åž‹ä¾‹ã€‚

### AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªæ–¹æ³•

ECS ã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ ã‚¿ã‚¹ã‚¯å®šç¾© â†’ ã‚³ãƒ³ãƒ†ãƒŠ â†’ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ãƒ­ã‚° ã‚¿ãƒ–
ã€ŒMount pointsã€ã«è¨­å®šã•ã‚ŒãŸãƒ‘ã‚¹ã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ åãŒç¢ºèªã§ãã‚‹ã€‚

---

## ä»•çµ„ã¿â‘¢ Linux ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ï¼ˆcapabilitiesï¼‰

### ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã¨ã¯

ã€Œroot æ¨©é™ã€ã‚’ç´°ã‹ãåˆ†å‰²ã—ãŸä»•çµ„ã¿ã€‚
root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã£ã¦ã‚‚ã€ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ç‰¹æ¨©æ“ä½œã¯ã§ããªã„ã€‚

> ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãï¼ˆä»•çµ„ã¿â‘ â‘¡ï¼‰ã¨ã¯å…¨ãåˆ¥ã®æ¦‚å¿µã€‚
> ã€Œã©ã‚“ãªç‰¹æ®Šæ“ä½œãŒã§ãã‚‹ã‹ã€ã‚’åˆ¶å¾¡ã™ã‚‹ã€‚

```
é€šå¸¸ã® root ã¯å¼·åŠ›ã™ãŽã‚‹:
root = chown ã§ãã‚‹ + raw socket ä½¿ãˆã‚‹ + ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œã‚Œã‚‹ + ...

ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã§åˆ†å‰²ã™ã‚‹ã¨:
CAP_CHOWN      â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…å¤‰æ›´
CAP_NET_RAW    â†’ ç”Ÿã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆé€å—ä¿¡
CAP_MKNOD      â†’ ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
CAP_SETUID     â†’ ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå¤‰æ›´ï¼ˆsetuid()ï¼‰
CAP_SETGID     â†’ ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚°ãƒ«ãƒ¼ãƒ—IDå¤‰æ›´ï¼ˆsetgid()ï¼‰
...ãªã©ç´„40ç¨®é¡ž
```

### æœ€åˆã®ã€Œé–“é•ã„ã€ã¨ Fargate ã®åˆ¶ç´„

æœ€åˆã« `drop = ["ALL"]` ã§ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã‚’å…¨éƒ¨å‰¥å¥ªã—ã‚ˆã†ã¨ã—ãŸã€‚
ã—ã‹ã— PHP-FPMãƒ»Nginx ã«ã¯ä»¥ä¸‹ã®ç†ç”±ã§å‹•ã‹ãªã‹ã£ãŸã€‚

**Nginx ã®å•é¡Œï¼ˆæœ€åˆã«é­é‡ï¼‰**
```
ã‚¨ãƒ©ãƒ¼: chown("/var/cache/nginx/client_temp", 101) failed (1: Operation not permitted)

åŽŸå› : Nginx ã®èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ /var/cache/nginx é…ä¸‹ã‚’ nginx ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« chown ã™ã‚‹
     â†’ CAP_CHOWN ãŒå¿…è¦
     â†’ drop=["ALL"] ã§ CAP_CHOWN ã‚‚å‰¥å¥ªã•ã‚Œã¦ã„ãŸãŸã‚å¤±æ•—
```

ã€Œã§ã¯ `add = ["CHOWN"]` ã§è¿½åŠ ã™ã‚Œã°ã„ã„ã€ã¨æ€ã£ãŸã‚‰ï¼š

```
ã‚¨ãƒ©ãƒ¼: CHOWN is not allowed on Fargate.

Fargate ã®åˆ¶ç´„: add ã§ãã‚‹ã®ã¯ SYS_PTRACE ã®ã¿
```

**PHP-FPM ã®å•é¡Œï¼ˆæ¬¡ã«é­é‡ï¼‰**
```
ã‚¨ãƒ©ãƒ¼: Fatal Error Unable to create lock file: Permission denied (13)

è¡¨é¢ä¸Šã®åŽŸå› : /tmp ãŒ root:root 755 â†’ www-data ãŒæ›¸ãè¾¼ã‚ãªã„
æ ¹æœ¬çš„ãªåŽŸå› : PHP-FPM ã®æœ¬æ¥ã®è¨­è¨ˆã¯ã€Œãƒžã‚¹ã‚¿ãŒ rootã€ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒ www-dataã€
             â†’ Dockerfile ã« USER www-data ã‚’æ›¸ã„ã¦ã—ã¾ã£ã¦ã„ãŸãŸã‚
               ãƒžã‚¹ã‚¿ã¾ã§ www-data ã«ãªã‚Šã€root:root 755 ã® /tmp ã«æ›¸ã‘ãªã‹ã£ãŸ
```

---

## PHP-FPM ã®æ­£ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’ç†è§£ã™ã‚‹

ã“ã‚ŒãŒä»Šå›žæœ€ã‚‚é‡è¦ãªå­¦ã³ã®ãƒã‚¤ãƒ³ãƒˆã€‚

### PHP-FPM ã¯ã€Œ2 å±¤æ§‹é€ ã€ã§è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHP-FPM ãƒžã‚¹ã‚¿ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆroot ã§èµ·å‹•ï¼‰         â”‚
â”‚                                              â”‚
â”‚  å½¹å‰²:                                       â”‚
â”‚  - ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®ç®¡ç†ãƒ»å†èµ·å‹•             â”‚
â”‚  - accept mutex ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ(/tmp ã«) â”‚
â”‚  - SIGTERM ç­‰ã®ã‚·ã‚°ãƒŠãƒ«å‡¦ç†                  â”‚
â”‚                                              â”‚
â”‚  â†“ fork + setuid(www-data)                  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PHP-FPM ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆwww-dataï¼‰    â”‚ â”‚
â”‚  â”‚                                         â”‚ â”‚
â”‚  â”‚ å½¹å‰²:                                   â”‚ â”‚
â”‚  â”‚ - PHP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®Ÿéš›ã®å‡¦ç†            â”‚ â”‚
â”‚  â”‚ - DB æŽ¥ç¶šãƒ»ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã             â”‚ â”‚
â”‚  â”‚ - æœ€å°æ¨©é™ã§å‹•ä½œï¼ˆæ”»æ’ƒæ™‚ã®è¢«å®³ã‚’é™å®šï¼‰  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãªãœ Dockerfile ã« USER www-data ã‚’æ›¸ã„ã¦ã¯ã„ã‘ãªã„ã‹

```dockerfile
# âŒ é–“é•ã„: PHP-FPM å…¨ä½“ã‚’ www-data ã§å‹•ã‹ã—ã¦ã—ã¾ã†
USER www-data
CMD ["php-fpm"]

# ã“ã®çŠ¶æ…‹ã§ã®å•é¡Œ:
# - ãƒžã‚¹ã‚¿ãŒ www-data â†’ /tmpï¼ˆroot:root 755ï¼‰ã«æ›¸ã‘ãªã„ â†’ Permission denied
# - ãƒžã‚¹ã‚¿ãŒ www-data â†’ setuid() ã§ www-data ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ fork ã™ã‚‹éš›ã«ã‚‚å•é¡ŒãŒç”Ÿã˜ã‚„ã™ã„
```

```dockerfile
# âœ… æ­£è§£: USER æŒ‡å®šãªã—ï¼ˆroot ã§èµ·å‹•ã—ã€PHP-FPM ãŒè‡ªåˆ†ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚’ã™ã‚‹ï¼‰
CMD ["php-fpm"]

# /usr/local/etc/php-fpm.d/www.conf ã«ã¯ä»¥ä¸‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
# user  = www-data   â† ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ã“ã®è¨­å®šã§ www-data ã«ãªã‚‹
# group = www-data
```

### ã€Œroot ã§å‹•ãã®ã¯å±é™ºã§ã¯ï¼Ÿã€ã¨ã„ã†ç–‘å•ã¸ã®å›žç­”

```
ãƒžã‚¹ã‚¿ãŒ root ã§ã‚‚ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã§å®ˆã‚‰ã‚Œã¦ã„ã‚‹:

readonlyRootFilesystem = true
  â†’ root ã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ›¸ãè¾¼ã¿ã¯ /tmp ã¨ storage ã®ã¿
  â†’ ãƒžãƒ«ã‚¦ã‚§ã‚¢ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«æ°¸ç¶šåŒ–ã§ããªã„

capabilities.drop = ["MKNOD","AUDIT_WRITE","SETFCAP","NET_RAW"]
  â†’ ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»ç›£æŸ»ãƒ­ã‚°æ”¹ã–ã‚“ãƒ»ä»–ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®æ¨©é™ä»˜ä¸Žãƒ»ç”Ÿãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡ ã¯ä¸å¯

Fargate ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹ãªæ¨©é™ï¼ˆSYS_ADMIN, NET_ADMIN ç­‰ï¼‰
  â†’ ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒ›ã‚¹ãƒˆã¸ã®è„±å‡ºçµŒè·¯ãŒé™ã‚‰ã‚Œã‚‹

ã“ã‚Œã¯ PHP-FPM ã®å…¬å¼ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨åŒã˜è¨­è¨ˆã€‚
ã€Œroot ã§èµ·å‹•ã™ã‚‹ãŒåˆ¶é™ã•ã‚ŒãŸç’°å¢ƒã§å‹•ãã€ãŒæ­£ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚
```

---

## çµæžœï¼šãªãœã€Œå€‹åˆ¥ dropã€ãŒæ­£è§£ãªã®ã‹

### `drop = ["ALL"]` ãŒã§ããªã„ç†ç”±

| ã‚³ãƒ³ãƒ†ãƒŠ | `drop = ["ALL"]` ãŒä½¿ãˆãªã„ç†ç”± |
|---------|-------------------------------|
| app (PHP-FPM) | ãƒžã‚¹ã‚¿ãŒ root â†’ ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ www-data ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ **CAP_SETUID / CAP_SETGID ãŒå¿…è¦** |
| web (Nginx) | èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ nginx ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ chown ã™ã‚‹ **CAP_CHOWN ãŒå¿…è¦** |

### Fargate ã§ã¯ `add` ã§è£œã†ã“ã¨ãŒã§ããªã„

```
Fargate ã®åˆ¶ç´„: add ã§ãã‚‹ã®ã¯ SYS_PTRACE ã®ã¿
â†’ CAP_CHOWN / CAP_SETUID / CAP_SETGID ã¯ add ä¸å¯
â†’ ã€Œdrop=ALL ã—ã¦ã‹ã‚‰å¿…è¦ãªã‚‚ã®ã‚’ addã€ã¨ã„ã†æ–¹é‡ã¯ Fargate ã§ä½¿ãˆãªã„
```

### ã ã‹ã‚‰ã€Œå±é™ºãªã‚‚ã®ã ã‘å€‹åˆ¥ dropã€ãŒæ­£è§£

```hcl
# ä¸¡ã‚³ãƒ³ãƒ†ãƒŠå…±é€šã®æ­£è§£è¨­å®š
capabilities = {
  add  = []
  drop = ["MKNOD", "AUDIT_WRITE", "SETFCAP", "NET_RAW"]
}
```

| drop ã™ã‚‹ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ | ä½•ãŒã§ããªããªã‚‹ã‹ |
|----------------------|----------------|
| `MKNOD` | ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`/dev/xxx`ï¼‰ã®ä½œæˆ â†’ PHP-FPMãƒ»Nginx ã«ã¯ä¸è¦ |
| `AUDIT_WRITE` | Linux ã‚«ãƒ¼ãƒãƒ«ç›£æŸ»ãƒ­ã‚°ã¸ã®æ›¸ãè¾¼ã¿ â†’ æ”»æ’ƒè€…ãŒç›£æŸ»ã‚’æ”¹ã–ã‚“ã™ã‚‹ã®ã‚’é˜²ã |
| `SETFCAP` | ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã‚’ä»˜ä¸Žã™ã‚‹ â†’ ã‚³ãƒ³ãƒ†ãƒŠå†…ã§æ¨©é™æ˜‡æ ¼ã•ã‚Œã‚‹ã®ã‚’é˜²ã |
| `NET_RAW` | ç”Ÿã®ãƒ‘ã‚±ãƒƒãƒˆé€å—ä¿¡ï¼ˆpingãƒ»ARP ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ç­‰ï¼‰ â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ”»æ’ƒã«æ‚ªç”¨ã•ã‚Œã‚‹ |

> **Fargate ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã™ã§ã«å®‰å…¨**
> SYS_ADMINãƒ»NET_ADMINãƒ»SYS_MODULE ç­‰ã®å±é™ºãªã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã¯
> Fargate ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ€åˆã‹ã‚‰å­˜åœ¨ã—ãªã„ã€‚
> ä¸Šè¨˜ 4 ã¤ã‚’ drop ã™ã‚‹ã ã‘ã§ååˆ†ãªãƒªã‚¹ã‚¯ä½Žæ¸›åŠ¹æžœãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

---

## AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®è¨­å®šæ–¹æ³•

Terraform ã‚’ä½¿ã‚ãšã«åŒã˜è¨­å®šã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¡Œã†æ‰‹é †ã€‚

### readonlyRootFilesystem

```
ECS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
â†’ ã‚¿ã‚¹ã‚¯å®šç¾© â†’ æ–°ã—ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ä½œæˆ
â†’ ã‚³ãƒ³ãƒ†ãƒŠã‚’é¸æŠž
â†’ ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ãƒ­ã‚°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³
â†’ ã€Œèª­ã¿å–ã‚Šå°‚ç”¨ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã€ã«ãƒã‚§ãƒƒã‚¯
```

### ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½é ˜åŸŸï¼‰ã®è¿½åŠ 

```
ã‚¿ã‚¹ã‚¯å®šç¾©ã®ç·¨é›†ç”»é¢
â†’ ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®å¤–å´ï¼‰
â†’ ã€Œãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¿½åŠ ã€â†’ åå‰: tmpï¼ˆã‚¿ã‚¤ãƒ—: ãªã—ï¼‰
â†’ ã‚³ãƒ³ãƒ†ãƒŠã®ã€Œãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã€ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ åã¨ containerPath ã‚’ç´ä»˜ã‘
```

### Linux ã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ï¼ˆcapabilitiesï¼‰

```
ã‚³ãƒ³ãƒ†ãƒŠã®ç·¨é›†ç”»é¢
â†’ ã€ŒDocker ã®è¨­å®šã€ã¾ãŸã¯ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³
â†’ ã€ŒLinux ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€â†’ã€Œã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã€
â†’ ã€Œå‰Šé™¤ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« MKNOD,AUDIT_WRITE,SETFCAP,NET_RAW ã‚’å…¥åŠ›
```

### JSON ã§ç›´æŽ¥ç·¨é›†ã™ã‚‹å ´åˆ

ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã€ŒJSONã€ã‚¿ãƒ–ã§ä»¥ä¸‹ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã‚‹ï¼š

```json
{
  "name": "app",
  "readonlyRootFilesystem": true,
  "mountPoints": [
    { "sourceVolume": "tmp", "containerPath": "/tmp", "readOnly": false }
  ],
  "linuxParameters": {
    "initProcessEnabled": true,
    "capabilities": {
      "add": [],
      "drop": ["MKNOD", "AUDIT_WRITE", "SETFCAP", "NET_RAW"]
    }
  }
}
```

---

## å…¨ä½“åƒã¾ã¨ã‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ECS Fargate ã‚¿ã‚¹ã‚¯                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   app ã‚³ãƒ³ãƒ†ãƒŠ          â”‚    â”‚   web ã‚³ãƒ³ãƒ†ãƒŠ                 â”‚  â”‚
â”‚  â”‚   (PHP-FPM)            â”‚    â”‚   (Nginx)                     â”‚  â”‚
â”‚  â”‚                        â”‚    â”‚                               â”‚  â”‚
â”‚  â”‚ readonlyRootFS: âœ…     â”‚    â”‚ readonlyRootFS: âœ…            â”‚  â”‚
â”‚  â”‚                        â”‚    â”‚                               â”‚  â”‚
â”‚  â”‚ /tmp â†’ ãƒœãƒªãƒ¥ãƒ¼ãƒ  âœ…   â”‚    â”‚ /var/cache/nginx â†’ ãƒœãƒªãƒ¥ãƒ¼ãƒ  â”‚  â”‚
â”‚  â”‚ â†‘ root ãŒæ›¸ãè¾¼ã‚€      â”‚    â”‚ /var/run        â†’ ãƒœãƒªãƒ¥ãƒ¼ãƒ   â”‚  â”‚
â”‚  â”‚   (root:root 755 ã§OK) â”‚    â”‚ â†‘ root ã® Nginx ãŒæ›¸ãè¾¼ã‚€   â”‚  â”‚
â”‚  â”‚                        â”‚    â”‚                               â”‚  â”‚
â”‚  â”‚ èµ·å‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼: root      â”‚    â”‚ èµ·å‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼: root             â”‚  â”‚
â”‚  â”‚ å‡¦ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼: www-data  â”‚    â”‚ å‡¦ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼: nginx            â”‚  â”‚
â”‚  â”‚ (PHP-FPM pool è¨­å®š)    â”‚    â”‚ (nginx.conf è¨­å®š)             â”‚  â”‚
â”‚  â”‚                        â”‚    â”‚                               â”‚  â”‚
â”‚  â”‚ capabilities:          â”‚    â”‚ capabilities:                 â”‚  â”‚
â”‚  â”‚  drop: å±é™ºãª4ã¤ âœ…    â”‚    â”‚  drop: å±é™ºãª4ã¤ âœ…           â”‚  â”‚
â”‚  â”‚  add:  ãªã—            â”‚    â”‚  add:  ãªã—                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€

| è¨­å®š | ãƒ•ã‚¡ã‚¤ãƒ« |
|-----|---------|
| readonlyRootFilesystem / capabilities / mountPoints | `terraform/ecs.tf` |
| capabilities ã‚’ deploy æ™‚ã«ç¢ºå®Ÿã«é©ç”¨ | `deploy.sh`ï¼ˆjq ã§ä¸Šæ›¸ãï¼‰ |
| PHP-FPM ã®ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆUSER ãªã—ï¼‰ | `docker/php/Dockerfile.prod` |

## ä»Šå›žã®è©¦è¡ŒéŒ¯èª¤ã®æ•™è¨“

```
é–“é•ã„â‘ : Dockerfile ã« USER www-data ã‚’æ›¸ã„ãŸ
  â†’ PHP-FPM ã®ãƒžã‚¹ã‚¿ã¾ã§ www-data ã«ãªã‚Šã€ECS ã® root:root ãƒœãƒªãƒ¥ãƒ¼ãƒ ã«æ›¸ã‘ãªããªã£ãŸ

é–“é•ã„â‘¡: drop=["ALL"] ã‚’ä½¿ãŠã†ã¨ã—ãŸ
  â†’ PHP-FPM ã« CAP_SETUID/SETGID ãŒå¿…è¦ãªãŸã‚å‹•ã‹ãªã„

é–“é•ã„â‘¢: add=["CHOWN"] ã§è£œãŠã†ã¨ã—ãŸ
  â†’ Fargate ã¯ SYS_PTRACE ã—ã‹ add ã§ããªã„

æ­£è§£: PHP-FPM æœ¬æ¥ã®è¨­è¨ˆï¼ˆãƒžã‚¹ã‚¿ã¯ rootã€ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ www-dataï¼‰ã‚’å°Šé‡ã—ã€
      å±é™ºãªã‚±ãƒ¼ãƒ‘ãƒ“ãƒªãƒ†ã‚£ã ã‘ã‚’å€‹åˆ¥ã« drop ã™ã‚‹
```

---

## ä»•çµ„ã¿â‘£ ECSã® tmpfs ãƒžã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹ä¸€æ™‚é ˜åŸŸã®ç¢ºä¿ï¼ˆçœŸã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

`readonlyRootFilesystem = true` ã‚’é©ç”¨ã—ãŸç’°å¢ƒã«ãŠã„ã¦ã€PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã©ã®ã€Œã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã®ãŸã³ã«åˆæœŸåŒ–ã•ã‚Œã¦ã‚‚ã‚ˆã„ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã€ã‚’ã©ã“ã«æ›¸ãè¾¼ã‚€ã¹ãã‹ã¨ã„ã†å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚

å…ˆã®ã€Œä»•çµ„ã¿â‘¡ã€ã§è§¦ã‚ŒãŸã‚ˆã†ã«ã€`/tmp` ãªã©ã‚’ã€ŒECSã®ç©ºãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆECS-managed volumeï¼‰ã€ã¨ã—ã¦ãƒã‚¤ãƒ³ãƒ‰ãƒžã‚¦ãƒ³ãƒˆã™ã‚‹ã¨ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãšãƒ›ã‚¹ãƒˆå´ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ï¼ˆ`root:root`ï¼‰ãŒå¹²æ¸‰ã—ã¦æ¨©é™ã‚¨ãƒ©ãƒ¼ã®åŽŸå› ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’å›žé¿ã™ã‚‹ãŸã‚ã®çœŸã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¯ã€**ã‚¿ã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®å¤–éƒ¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒžã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã›ãšã€å„ã‚³ãƒ³ãƒ†ãƒŠã® `linuxParameters` å†…ã«å®šç¾©ã™ã‚‹ `tmpfs` (Ramdisk) æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨** ã§ã™ã€‚

### tmpfsã®ãƒ¡ãƒªãƒƒãƒˆ
1. **ãƒ›ã‚¹ãƒˆå±¤ã¨ã®æ¨©é™ãƒˆãƒ©ãƒ–ãƒ«ãŒãªã„:** ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒ¢ãƒªå†…ã«ç›´æŽ¥ç”¨æ„ã•ã‚Œã‚‹ç‹¬ç«‹ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§ã‚»ã‚­ãƒ¥ã‚¢ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å¯èƒ½ã§ã™ï¼ˆ`uid`, `gid` ã®æŒ‡å®šãŒå¯èƒ½ï¼‰ã€‚
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Š:** ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã§ã¯ãªãRAMä¸Šã«ãƒ‡ãƒ¼ã‚¿ãŒé…ç½®ã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«I/OãŒæ¥µã‚ã¦é«˜é€Ÿã«ãªã‚Šã¾ã™ã€‚
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨å®Œå…¨ãªæ®ç™ºæ€§:** ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ›ã‚¹ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ®‹ã‚‹ãƒªã‚¹ã‚¯ãŒã‚¼ãƒ­ã«ãªã‚Šã¾ã™ï¼ˆã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†ã¨åŒæ™‚ã«ãƒ¡ãƒ¢ãƒªã‹ã‚‰æ¶ˆæ»…ã—ã¾ã™ï¼‰ã€‚

### Terraformã§ã®è¨­å®šä¾‹ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

```hcl
linuxParameters = {
  tmpfs = [
    {
      containerPath = "/tmp"
      size          = 64
      mountOptions  = ["uid=33", "gid=33"] # www-data ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒžã‚¦ãƒ³ãƒˆ
    },
    {
      containerPath = "/var/run"
      size          = 64
      mountOptions  = ["uid=101", "gid=101"] # nginx ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒžã‚¦ãƒ³ãƒˆ
    }
  ]
}
```

> **AWSå…¬å¼ã§ã®æŽ¨å¥¨äº‹é …**
> AWS Security Hub ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã‚‚ã€`readonlyRootFilesystem` ã‚’æœ‰åŠ¹åŒ–ã—ã¤ã¤ã€ã‚·ã‚¹ãƒ†ãƒ ãŒç¨¼åƒã™ã‚‹ãŸã‚ã«å¿…è¦ãªä¸€æ™‚çš„ãªæ›¸ãè¾¼ã¿é ˜åŸŸã¨ã—ã¦ã“ã® `tmpfs` ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒæŽ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
>
> ðŸ“Œ **å‚è€ƒãƒªãƒ³ã‚¯:**
> - [AWS ECS Best Practices Guide: Security tasks and containers](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/security-tasks-containers.html)
> - [AWS ECS Developer Guide: Task Definition Parameters (`tmpfs`)](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_tmpfs)
