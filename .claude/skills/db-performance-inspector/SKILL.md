---
name: db-performance-inspector
description: |
    データベースの構造と実データの統計（カーディナリティ）を確認し、
    パフォーマンス上の欠陥を特定します。コードレビューの結果、
    クエリの最適化やインデックスの検討が必要になった場合に優先して使用してください。
allowed-tools: ["mysql-db"]
---

# DB パフォーマンスチェックの手順

データベースのパフォーマンス問題を解決するために、以下の手順で調査および改善案の作成を行ってください。

## 1. スキーマと既存インデックスの把握

調査対象のテーブルに対して以下の操作を行い、現在の構造を正しく理解してください。

-   `list_tables` でテーブルの存在を確認する。
-   `describe_table` を実行し、カラムの型と既存のインデックス（KEY 欄）を確認する。

## 2. データの統計情報の確認（カーディナリティ調査）

インデックスの有効性を判断するために、対象カラムのデータの分散具合を調査してください。

-   `SELECT COUNT(*), COUNT(DISTINCT カラム名) FROM テーブル名` を実行する。
-   全件数に対して種類（DISTINCT 数）が極端に少ない場合、単一インデックスの効果が薄いと判断し、複合インデックスなどを検討してください。

## 3. 実行計画（EXPLAIN）による検証

スロークエリの疑いがある操作に対して、実際にデータベースがどのようにデータを読み取っているかを確認してください。

-   `EXPLAIN SELECT ...` を実行し、`type` 欄が `ALL`（フルスキャン）になっていないか、`rows` 欄で過大な走査が行われていないかを確認する。

## 4. 改善案の提示とマイグレーション作成

調査結果に基づき、以下の内容を出力してください。

-   **現状分析**: インデックスが不足している箇所と、その根拠（実行計画や統計情報）。
-   **解決策**: Laravel の命名規則（例: `idx_テーブル名_カラム名`）に沿ったインデックス追加の提案。
-   **実装**: `php artisan make:migration` でそのまま使用できる、正確な `up` メソッドと `down` メソッドのコード。

## 注意事項

-   個人情報（氏名、メールアドレス、住所等）の生データを直接読み取ることは避け、COUNT 関数や EXPLAIN コマンドによる構造的な事実のみを抽出してください。
-   データの更新（UPDATE/DELETE）は行わず、参照（SELECT）による調査に徹してください。
